name: Flutter Build with OpenCV

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Flutter
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Flutter Pub Get
      run: flutter pub get

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Gradle 8.2 (—á—Ç–æ–±—ã —Å–æ–≤–ø–∞–¥–∞–ª–æ —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π)
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.2'

    # üî• –°–ö–ê–ß–ò–í–ê–ù–ò–ï OPENCV (–í –ø–∞–ø–∫—É android/opencv)
    - name: Download and Setup OpenCV 4.12.0
      run: |
        echo "Downloading OpenCV..."
        wget -q https://github.com/opencv/opencv/releases/download/4.12.0/opencv-4.12.0-android-sdk.zip
        unzip -q opencv-4.12.0-android-sdk.zip
        
        # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤–Ω—É—Ç—Ä—å –ø–∞–ø–∫–∏ android!
        mv OpenCV-android-sdk android/opencv
        
        echo "Moving OpenCV libs to jniLibs..."
        mkdir -p android/opencv/sdk/java/src/main/jniLibs
        cp -r android/opencv/sdk/native/libs/* android/opencv/sdk/java/src/main/jniLibs/

    # üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–æ–ø–∏—Ä—É–µ–º libc++_shared.so (–¥–ª—è —Ä–∞–±–æ—Ç—ã OpenCV)
    - name: Inject Standard C++ Library
      run: |
        NDK_ROOT=$ANDROID_NDK_HOME
        
        copy_stl() {
           ARCH_NAME=$1
           ABI_NAME=$2
           # –ò—â–µ–º libc++_shared.so
           STL_FILE=$(find $NDK_ROOT -name "libc++_shared.so" | grep "$ABI_NAME" | head -n 1)
           
           if [ -z "$STL_FILE" ]; then
               echo "‚ùå ERROR: libc++_shared.so not found for $ARCH_NAME!"
               exit 1
           fi
           
           echo "‚úÖ Found: $STL_FILE -> $ARCH_NAME"
           cp "$STL_FILE" "android/opencv/sdk/java/src/main/jniLibs/$ARCH_NAME/"
        }

        copy_stl "arm64-v8a" "aarch64"
        copy_stl "armeabi-v7a" "arm-linux-androideabi"
        copy_stl "x86" "i686"
        copy_stl "x86_64" "x86_64"

    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π build.gradle –¥–ª—è OpenCV
    - name: Configure OpenCV build.gradle
      run: |
        cat <<EOF > android/opencv/sdk/java/build.gradle
        apply plugin: 'com.android.library'
        android {
            namespace 'org.opencv'
            compileSdkVersion 34
            defaultConfig {
                minSdkVersion 24
                targetSdkVersion 34
            }
            buildFeatures {
                buildConfig true
            }
            buildTypes {
                release {
                    minifyEnabled false
                }
            }
            sourceSets {
                main {
                    jniLibs.srcDirs = ['src/main/jniLibs']
                    java.srcDirs = ['src']
                    res.srcDirs = ['res']
                    manifest.srcFile 'AndroidManifest.xml'
                }
            }
        }
        EOF

    - name: Build Flutter APK
      run: flutter build apk --debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: build/app/outputs/flutter-apk/app-debug.apk
