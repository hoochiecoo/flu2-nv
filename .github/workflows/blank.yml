name: Android Build with OpenCV

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.2'

    # üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ó–∞—Å—Ç–∞–≤–ª—è–µ–º Android —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞—Ç—å .so —Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫
    # –≠—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç –æ—à–∏–±–∫—É "FILE MISSING" –≤ –≤–∞—à–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ
    - name: Force Extract Native Libs & Remove Icons
      run: |
        sed -i '/android:icon/d' app/src/main/AndroidManifest.xml
        sed -i '/android:roundIcon/d' app/src/main/AndroidManifest.xml
        # –î–æ–±–∞–≤–ª—è–µ–º extractNativeLibs="true" –≤ —Ç–µ–≥ <application>
        sed -i 's/<application/<application android:extractNativeLibs="true"/g' app/src/main/AndroidManifest.xml

    - name: Download and Setup OpenCV 4.12.0
      run: |
        echo "Downloading OpenCV..."
        wget -q https://github.com/opencv/opencv/releases/download/4.12.0/opencv-4.12.0-android-sdk.zip
        unzip -q opencv-4.12.0-android-sdk.zip
        mv OpenCV-android-sdk opencv
        
        echo "Moving OpenCV libs to jniLibs..."
        mkdir -p opencv/sdk/java/src/main/jniLibs
        cp -r opencv/sdk/native/libs/* opencv/sdk/java/src/main/jniLibs/

    # üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ö–æ–ø–∏—Ä—É–µ–º libc++_shared.so (–±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫)
    - name: Inject Standard C++ Library
      run: |
        echo "Looking for NDK..."
        # –ù–∞ GitHub Actions NDK –æ–±—ã—á–Ω–æ —Ç—É—Ç
        NDK_ROOT=$ANDROID_NDK_HOME
        echo "NDK Path: $NDK_ROOT"
        
        copy_stl() {
           ARCH_NAME=$1  # –ù–∞–ø—Ä–∏–º–µ—Ä: arm64-v8a
           ABI_NAME=$2   # –ù–∞–ø—Ä–∏–º–µ—Ä: aarch64
           
           echo "--- Processing $ARCH_NAME ---"
           
           # –ò—â–µ–º —Ñ–∞–π–ª libc++_shared.so –≤–Ω—É—Ç—Ä–∏ NDK, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
           # head -n 1 –±–µ—Ä–µ—Ç –ø–µ—Ä–≤—ã–π –ø–æ–ø–∞–≤—à–∏–π—Å—è (–æ–±—ã—á–Ω–æ —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π)
           STL_FILE=$(find $NDK_ROOT -name "libc++_shared.so" | grep "$ABI_NAME" | head -n 1)
           
           if [ -z "$STL_FILE" ]; then
               echo "‚ùå ERROR: libc++_shared.so not found for $ARCH_NAME!"
               exit 1 # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–±–æ—Ä–∫–∏, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
           fi
           
           echo "‚úÖ Found: $STL_FILE"
           cp "$STL_FILE" "opencv/sdk/java/src/main/jniLibs/$ARCH_NAME/"
        }

        # –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
        copy_stl "arm64-v8a" "aarch64"
        copy_stl "armeabi-v7a" "arm-linux-androideabi"
        copy_stl "x86" "i686"
        copy_stl "x86_64" "x86_64"

    - name: Configure build.gradle
      run: |
        cat <<EOF > opencv/sdk/java/build.gradle
        apply plugin: 'com.android.library'
        android {
            namespace 'org.opencv'
            compileSdkVersion 34
            defaultConfig {
                minSdkVersion 24
                targetSdkVersion 34
            }
            buildFeatures {
                buildConfig true
            }
            buildTypes {
                release {
                    minifyEnabled false
                }
            }
            sourceSets {
                main {
                    jniLibs.srcDirs = ['src/main/jniLibs']
                    java.srcDirs = ['src']
                    res.srcDirs = ['res']
                    manifest.srcFile 'AndroidManifest.xml'
                }
            }
        }
        EOF

    # –î–æ–±–∞–≤–ª—è–µ–º packagingOptions –≤ app/build.gradle, —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    - name: Patch App Build Gradle
      run: |
        cat <<EOF >> app/build.gradle
        android {
            packagingOptions {
                pickFirst 'lib/*/libc++_shared.so'
                pickFirst 'lib/*/libopencv_java4.so'
            }
        }
        EOF

    - name: Build Debug APK
      run: gradle assembleDebug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk
