name: Android Build with OpenCV

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.2'

    - name: Fix Manifest (Remove missing icons)
      run: |
        sed -i '/android:icon/d' app/src/main/AndroidManifest.xml
        sed -i '/android:roundIcon/d' app/src/main/AndroidManifest.xml

    - name: Download and Setup OpenCV 4.12.0
      run: |
        echo "Downloading OpenCV..."
        wget -q https://github.com/opencv/opencv/releases/download/4.12.0/opencv-4.12.0-android-sdk.zip
        unzip -q opencv-4.12.0-android-sdk.zip
        mv OpenCV-android-sdk opencv
        
        echo "üî• FIX: Moving native libs to standard folder..."
        mkdir -p opencv/sdk/java/src/main/jniLibs
        cp -r opencv/sdk/native/libs/* opencv/sdk/java/src/main/jniLibs/
        
        echo "üî• FIX: Injecting libc++_shared.so from NDK..."
        # OpenCV –Ω–∞–ø–∏—Å–∞–Ω–∞ –Ω–∞ C++ –∏ —Ç—Ä–µ–±—É–µ—Ç —ç—Ç—É –±–∏–±–ª–∏–æ—Ç–µ–∫—É. –ú—ã –∫—Ä–∞–¥–µ–º –µ—ë –∏–∑ NDK —Å–µ—Ä–≤–µ—Ä–∞.
        
        # 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ NDK
        NDK_ROOT=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib
        
        # 2. –ö–æ–ø–∏—Ä—É–µ–º –¥–ª—è arm64-v8a (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã)
        if [ -d "opencv/sdk/java/src/main/jniLibs/arm64-v8a" ]; then
            cp "$NDK_ROOT/aarch64-linux-android/libc++_shared.so" opencv/sdk/java/src/main/jniLibs/arm64-v8a/
        fi
        
        # 3. –ö–æ–ø–∏—Ä—É–µ–º –¥–ª—è armeabi-v7a (—Å—Ç–∞—Ä—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã)
        if [ -d "opencv/sdk/java/src/main/jniLibs/armeabi-v7a" ]; then
            cp "$NDK_ROOT/arm-linux-androideabi/libc++_shared.so" opencv/sdk/java/src/main/jniLibs/armeabi-v7a/
        fi

        # 4. –ö–æ–ø–∏—Ä—É–µ–º –¥–ª—è x86_64 (—ç–º—É–ª—è—Ç–æ—Ä—ã)
        if [ -d "opencv/sdk/java/src/main/jniLibs/x86_64" ]; then
            cp "$NDK_ROOT/x86_64-linux-android/libc++_shared.so" opencv/sdk/java/src/main/jniLibs/x86_64/
        fi
        
        echo "Injecting modern build.gradle..."
        cat <<EOF > opencv/sdk/java/build.gradle
        apply plugin: 'com.android.library'
        android {
            namespace 'org.opencv'
            compileSdkVersion 34
            defaultConfig {
                minSdkVersion 24
                targetSdkVersion 34
            }
            buildFeatures {
                buildConfig true
            }
            buildTypes {
                release {
                    minifyEnabled false
                }
            }
            sourceSets {
                main {
                    jniLibs.srcDirs = ['src/main/jniLibs']
                    java.srcDirs = ['src']
                    res.srcDirs = ['res']
                    manifest.srcFile 'AndroidManifest.xml'
                }
            }
        }
        EOF

    - name: Build Debug APK
      run: gradle assembleDebug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk
